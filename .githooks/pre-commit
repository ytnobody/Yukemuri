#!/bin/bash
set -e

# Get changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$CHANGED_FILES" ]; then
  exit 0
fi

# Filter TypeScript/JavaScript files
STAGED_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Get the project root
PROJECT_ROOT=$(git rev-parse --show-toplevel)
cd "$PROJECT_ROOT"

# Format staged files
echo "üîß Formatting staged files..."
./node_modules/.pnpm/@biomejs+cli-linux-x64@2.3.6/node_modules/@biomejs/cli-linux-x64/biome format --write $STAGED_FILES

# Lint staged files
echo "üîç Linting staged files..."
./node_modules/.pnpm/@biomejs+cli-linux-x64@2.3.6/node_modules/@biomejs/cli-linux-x64/biome lint --write $STAGED_FILES

# Re-stage formatted/fixed files
echo "üì¶ Re-staging fixed files..."
echo "$STAGED_FILES" | xargs git add

echo "‚úÖ Pre-commit checks passed!"
